# 改善計画（10件・優先順）（2026-02-14）

> 各項目は「小差分」を優先し、後方互換の案も併記すること。

## 1)
- タイトル: 権限設定INSERTの例外分類を導入する
- 目的: DB障害と重複登録を正しく区別し、誤案内を防ぐ。
- 根拠（該当箇所）: `src/db.ts:257-271`、`src/db.ts:294-308`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: `catch` を `catch (error)` に変更し、重複制約のみ `false`、それ以外を throw。
- 実装手順（箇条書き）:
  - SQLite制約エラー判定ヘルパーを `db.ts` に追加。
  - `addAllowedUser` / `addAllowedRole` の `catch` を例外分類化。
  - 非重複例外は既存リスナーに伝播させる。
- テスト観点:
  - 同一ユーザー/ロールを2回追加して2回目のみ「既存」扱い。
  - DBロック等を意図的に発生させ、エラー扱いになること。
- ロールバック案: 例外分類ヘルパーを削除し、従来 `catch { return false; }` に戻す。
- 参考/未確認: SQLite result codes（未確認）

## 2)
- タイトル: 募集メンションを分割送信対応にする（bosyu/bpsr）
- 目的: 2000文字制限超過を防ぎ、送信失敗を回避する。
- 根拠（該当箇所）: `src/lib/bosyu-utils.ts:549,552-557`、`src/lib/bosyu-bpsr-utils.ts:664,667-672`、`src/interaction-handlers/BosyuMentionButtonHandler.ts:105-108`、`src/interaction-handlers/BosyuBpsrMentionButtonHandler.ts:107-110`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: 既存の文字列返却関数を `string[]` 返却へ拡張し、ハンドラ側で順次送信。
- 実装手順（箇条書き）:
  - `buildBosyuMentionMessage` / `buildBosyuBpsrMentionMessage` を分割版に置換。
  - ボタン/モーダル両ハンドラで配列送信に変更。
  - 既存の文面と操作フローは維持。
- テスト観点:
  - 参加者80人以上相当で送信エラーにならないこと。
  - カスタムメッセージあり/なしで分割されること。
- ロールバック案: 単一メッセージ返却に戻して送信を1回に戻す。
- 参考/未確認: Discord message limits（未確認）

## 3)
- タイトル: Precondition拒否通知をレベル分離する
- 目的: 監視ノイズを減らし、重大障害通知の可視性を確保する。
- 根拠（該当箇所）: `src/listeners/ChatInputCommandDenied.ts:31-36`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: 拒否系（想定内）をDM通知対象から除外し、未知エラーのみ通知。
- 実装手順（箇条書き）:
  - `error.identifier` で拒否種別を判定。
  - 許可拒否系はログのみ、未知例外のみ `notifyErrorToOwner`。
  - 通知対象外でもユーザー返信は現状維持。
- テスト観点:
  - 権限なし実行でDM通知されないこと。
  - 未知エラー時はDM通知されること。
- ロールバック案: フィルタを削除し全件通知へ戻す。
- 参考/未確認: Sapphire event payload詳細（未確認）

## 4)
- タイトル: リマインダー送信失敗時の削除方針を見直す
- 目的: 一時障害時の通知消失を防ぐ。
- 根拠（該当箇所）: `src/scheduler.ts:23-25`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Med
- 変更方針（小差分）: 成功時のみ削除し、失敗時は再試行用に保持する。
- 実装手順（箇条書き）:
  - `finally` の削除を成功分岐へ移動。
  - 失敗時に再スケジュールする最小ロジックを追加。
  - 再試行上限を定数化して無限再試行を防止。
- テスト観点:
  - DM失敗時にレコードが残ること。
  - 後続実行で再送されること。
- ロールバック案: 失敗時削除へ戻す。
- 参考/未確認: DM失敗コード体系（未確認）

## 5)
- タイトル: `mention-reactors` の全件取得と429再試行を導入する
- 目的: 大規模サーバーでの取りこぼしと送信失敗を減らす。
- 根拠（該当箇所）: `src/lib/mention-reactors-utils.ts:190,201`、`src/interaction-handlers/MentionReactorsButtonHandler.ts:116`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Med
- 変更方針（小差分）: 既存API形状を維持したまま内部をページング化し、送信をリトライ対応。
- 実装手順（箇条書き）:
  - `reaction.users.fetch` を `after` で反復取得するヘルパー化。
  - `sendWithRetry` を追加し、429時のみ待機再試行。
  - 失敗時は最終エラーをユーザー返信へ集約。
- テスト観点:
  - 100件超リアクションで全件取得できること。
  - 疑似429発生時に最終的に送信成功すること。
- ロールバック案: 旧実装（100件固定・単発送信）に戻す。
- 参考/未確認: Discord Rate Limits（未確認）

## 6)
- タイトル: 募集ボタン更新に競合対策（再取得再計算）を導入する
- 目的: 同時クリック時のロストアップデートを抑止する。
- 根拠（該当箇所）: `src/interaction-handlers/BosyuButtonHandler.ts:45,99-102`、`src/interaction-handlers/BosyuBpsrButtonHandler.ts:46,104-107`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Med
- 変更方針（小差分）: 更新直前に最新メッセージ再取得し、状態を再計算して更新。
- 実装手順（箇条書き）:
  - `message.fetch()` ベースの最新状態取得を追加。
  - `apply*Action` を最新状態に適用。
  - 競合検知時に1回再試行（それでも失敗ならno-op）。
- テスト観点:
  - 2ユーザー同時クリック時に状態不整合が減ること。
  - 連打時に二重参加しないこと。
- ロールバック案: 既存のローカル状態更新に戻す。
- 参考/未確認: Interaction update競合仕様（未確認）

## 7)
- タイトル: ハンドラcatchでの障害通知経路を明示化する
- 目的: ログだけで終わる障害を減らし、観測性を上げる。
- 根拠（該当箇所）: `src/interaction-handlers/BpsrRoleButtonHandler.ts:102-113`、`src/interaction-handlers/VerifyModalHandler.ts:115-124,168-170`
- 影響度（High/Med/Low）: Med
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: catch内で `notifyErrorToOwner` を明示呼び出し、ユーザー返信は維持。
- 実装手順（箇条書き）:
  - `notifyErrorToOwner` を import。
  - catch分岐ごとに `source`/`errorCode` を付与して通知。
  - 二重返信防止分岐は維持。
- テスト観点:
  - 権限エラー時にユーザー返信と通知が両立すること。
  - 通知失敗時でも処理が二次障害化しないこと。
- ロールバック案: catch内通知を削除。
- 参考/未確認: プロジェクトエラーハンドリング方針（AGENTS.md）

## 8)
- タイトル: 募集メンション系を `TextBasedChannel` ベースに統一する
- 目的: スレッド対応を有効化し、型安全性を向上する。
- 根拠（該当箇所）: `src/interaction-handlers/BosyuMentionButtonHandler.ts:48-49`、`src/interaction-handlers/BosyuBpsrMentionButtonHandler.ts:49-50`、`src/interaction-handlers/BosyuMentionModalHandler.ts:46-47`、`src/interaction-handlers/BosyuBpsrMentionModalHandler.ts:47-48`
- 影響度（High/Med/Low）: Med
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: `TextChannel` キャストを排除し、`messages`/`send` の存在チェックで処理。
- 実装手順（箇条書き）:
  - 型を `TextBasedChannel` に変更。
  - `messages` / `send` の型ガードを追加。
  - TODOコメントを解消。
- テスト観点:
  - 通常チャンネルとスレッド双方で取得/送信できること。
  - 対応外チャンネルで明示エラーになること。
- ロールバック案: 既存 `TextChannel` キャストに戻す。
- 参考/未確認: discord.js channel type docs（未確認）

## 9)
- タイトル: DBスキーマバージョン管理を導入する
- 目的: 将来変更時の安全な段階移行を可能にする。
- 根拠（該当箇所）: `src/db.ts:27`
- 影響度（High/Med/Low）: Med
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Med
- 変更方針（小差分）: `meta` の `schema_version` を利用する最小マイグレーション基盤を追加。
- 実装手順（箇条書き）:
  - `getSchemaVersion` / `setSchemaVersion` 実装。
  - `migrations` 配列を用意し、未適用のみ実行。
  - `docs/DB-SCHEMA.md` にバージョン運用を追記。
- テスト観点:
  - 空DB・既存DBの双方で起動成功すること。
  - 冪等実行で副作用がないこと。
- ロールバック案: migration適用ロジックを無効化する。
- 参考/未確認: SQLite migration pattern（未確認）

## 10)
- タイトル: DX品質ゲート（format/CI）を最小導入する
- 目的: 整形差分ノイズと回帰混入を減らす。
- 根拠（該当箇所）: `pnpm format:check` 失敗、`.github/workflows` 未整備
- 影響度（High/Med/Low）: Med
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: まず未整形3ファイルを整形し、CIで `pnpm verify` + `pnpm format:check` を実行。
- 実装手順（箇条書き）:
  - `pnpm format` または対象ファイル個別整形を実施。
  - `.github/workflows/ci.yml` を追加。
  - PR時必須チェックに設定。
- テスト観点:
  - ローカルで `pnpm verify` / `pnpm format:check` が通ること。
  - CIで同コマンドが再現実行できること。
- ロールバック案: CIワークフローを無効化し、整形ゲートを外す。
- 参考/未確認: GitHub Actions Node guide（未確認）
