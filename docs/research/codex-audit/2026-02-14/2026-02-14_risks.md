# リスク一覧（2026-02-14）

## High
- タイトル: 募集メンションが2000文字制限を超えると送信失敗する
  - 現象: `bosyu` / `bosyu-bpsr` のメンション本文を1メッセージ連結で送信しているため、参加者が多いと送信失敗する。
  - 根拠（該当ファイル/関数/行の目安）: `src/lib/bosyu-utils.ts:549,552-557`、`src/lib/bosyu-bpsr-utils.ts:664,667-672`、`src/interaction-handlers/BosyuMentionButtonHandler.ts:105-108`、`src/interaction-handlers/BosyuBpsrMentionButtonHandler.ts:107-110`
  - 影響: 参加者への通知漏れ、再送運用の手作業化。
  - 推奨対応: 分割送信ヘルパーを共通化し、チャンク単位で順次送信する。

- タイトル: 募集ボタンの同時操作でロストアップデートが発生しうる
  - 現象: `interaction.message.embeds[0]` を起点にローカル計算後 `interaction.update` しており、同時操作時に後勝ち上書きになる。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/BosyuButtonHandler.ts:45,80-101`、`src/interaction-handlers/BosyuBpsrButtonHandler.ts:46,85-106`
  - 影響: 参加者一覧・残枠の不整合。
  - 推奨対応: 更新前に最新メッセージ再取得して再計算、必要に応じて1回再試行する。

- タイトル: 権限設定追加処理が例外を握りつぶし、障害を重複扱いする
  - 現象: `addAllowedUser` / `addAllowedRole` が例外種別を問わず `false` を返す。
  - 根拠（該当ファイル/関数/行の目安）: `src/db.ts:257-271`、`src/db.ts:294-308`
  - 影響: DBロック/I/O障害が「既に登録済み」と誤表示され、障害発見が遅れる。
  - 推奨対応: `SQLITE_CONSTRAINT` のみ重複扱い、それ以外は throw する。

- タイトル: リマインダー送信失敗時にデータが消失する
  - 現象: 送信成否に関わらず `finally` で `deleteReminder` を実行している。
  - 根拠（該当ファイル/関数/行の目安）: `src/scheduler.ts:23-25`
  - 影響: 一時障害でも通知が永久に失われる。
  - 推奨対応: 成功時のみ削除し、失敗時は再試行可能状態を残す。

- タイトル: Precondition拒否を毎回オーナーDM通知しており、運用ノイズが高い
  - 現象: 想定内拒否でも `notifyErrorToOwner` が毎回実行される。
  - 根拠（該当ファイル/関数/行の目安）: `src/listeners/ChatInputCommandDenied.ts:31-36`
  - 影響: 監視ノイズで重大障害通知が埋もれる。
  - 推奨対応: 拒否系は通知レベルを分離し、DM通知対象を限定する。

## Med
- タイトル: `mention-reactors` はリアクションユーザー取得が100件上限
  - 現象: `reaction.users.fetch({ limit: 100 })` を1回しか呼ばない。
  - 根拠（該当ファイル/関数/行の目安）: `src/lib/mention-reactors-utils.ts:190,201`
  - 影響: 大規模サーバーでメンション漏れが発生する。
  - 推奨対応: `after` を使ったページング取得を導入する。

- タイトル: `mention-reactors` の送信に429再試行がない
  - 現象: 分割送信はあるが、`send` の失敗時に待機再試行がない。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/MentionReactorsButtonHandler.ts:116`
  - 影響: バースト時に送信失敗・通知欠落が発生する。
  - 推奨対応: 軽量キュー + `retry_after` を使う再試行ヘルパーを導入する。

- タイトル: 一部ハンドラで例外を握り、監視通知に載らない
  - 現象: `catch` でログのみ/ユーザー返信のみ実施し、`notifyErrorToOwner` へ連携しない。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/BpsrRoleButtonHandler.ts:102-113`、`src/interaction-handlers/VerifyModalHandler.ts:115-124,168-170`
  - 影響: 再現しづらい障害の観測性が低い。
  - 推奨対応: catch内で通知を明示し、致命系のみ再throwする。

- タイトル: DBマイグレーション版管理が未実装
  - 現象: `meta` テーブルはあるが `schema_version` を使っていない。
  - 根拠（該当ファイル/関数/行の目安）: `src/db.ts:27`
  - 影響: 将来のスキーマ変更時に起動失敗や手作業対応が増える。
  - 推奨対応: 起動時マイグレーションの最小フレームを導入する。

- タイトル: 募集メンション系で `TextChannel` 固定キャストが残り、スレッド未対応
  - 現象: コメントで TODO があり、`TextChannel` 固定のまま。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/BosyuMentionButtonHandler.ts:48-49`、`src/interaction-handlers/BosyuBpsrMentionButtonHandler.ts:49-50`、`src/interaction-handlers/BosyuMentionModalHandler.ts:46-47`、`src/interaction-handlers/BosyuBpsrMentionModalHandler.ts:47-48`
  - 影響: スレッド運用時に機能不全になりうる。
  - 推奨対応: `TextBasedChannel` ベースへ移行し、送信可能判定を明示する。

## Low
- タイトル: `/help` キャッシュが2箇所に分散している
  - 現象: `HelpCommand` と `HelpButtonHandler` が別キャッシュ変数を持つ。
  - 根拠（該当ファイル/関数/行の目安）: `src/commands/HelpCommand.ts:17-23`、`src/interaction-handlers/HelpButtonHandler.ts:20-26`
  - 影響: ヘルプ更新機能追加時に整合性管理が煩雑。
  - 推奨対応: `help-utils.ts` にキャッシュを一本化する。

- タイトル: `format:check` が失敗し、整形品質ゲートが不安定
  - 現象: Prettier未整形ファイルが残存。
  - 根拠（該当ファイル/関数/行の目安）: `pnpm format:check` 実行結果（`docs/agent-notes/_TEMPLATE.md`、`src/lib/bosyu-bpsr-utils.ts`、`src/listeners/InteractionHandlerError.ts`）
  - 影響: PR時の差分ノイズ増加、レビュー効率低下。
  - 推奨対応: 該当ファイル整形 + CIで `format:check` を実行する。

- タイトル: CIワークフロー未整備
  - 現象: `.github/workflows` 配下に設定ファイルが見当たらない。
  - 根拠（該当ファイル/関数/行の目安）: `.github/workflows` ディレクトリ調査結果（ファイル未検出）
  - 影響: 品質ゲートがローカル任せになり、回帰混入リスクが上がる。
  - 推奨対応: 最小CI（`pnpm verify` + `pnpm format:check`）を導入する。

## 参考
- 解消済み確認: `ephemeral: true` は `src` 配下で残存なし（`rg -n "ephemeral\\s*:\\s*true" src`）。
- 公式URL優先（未確認は未確認と明記）
