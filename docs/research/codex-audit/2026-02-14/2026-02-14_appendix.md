# 付録（2026-02-14）

## 重要な設計メモ（将来拡張のため）
- 権限レイヤ案:
  - `ChatInputCommandDenied` は「想定内拒否」と「異常系」を分離し、オーナーDMは異常系のみ。
  - `restricted` 判定と操作主体判定（owner / allowed user / role）は `permission-utils.ts` に寄せて重複を減らす。
- 共通ユーティリティ案:
  - メンション分割送信を `lib/message-chunk-utils.ts` に統一し、`bosyu` / `bosyu-bpsr` / `mention-reactors` で再利用。
  - 429再試行を `lib/discord-send-utils.ts` の `sendWithRetry` に集約する。
  - 募集ボタン更新は `refreshStateAndApplyAction` ヘルパーに切り出して競合対策を共通化。
- エラー分類/ログ設計案:
  - `expected_denied` / `recoverable` / `fatal` の3分類を採用。
  - `recoverable` は閾値超過時のみ通知、`fatal` は即通知。
  - `errorCode` は `DOMAIN_ACTION_KIND`（例: `DB_ALLOW_INSERT_FATAL`）へ統一。
- 設定管理案:
  - 再試行回数・待機秒・通知抑止秒を環境変数化（例: `SEND_RETRY_MAX`, `ERROR_NOTIFY_THROTTLE_SEC`）。
  - `config.ts` にデフォルト値と妥当性チェックを集約する。

## 2026-02-06 監査からの差分
- 解消済み:
  - `ephemeral: true` の残存は確認されなかった（`src` 全体で0件）。
- 改善済み:
  - `package.json` に `lint` / `format` / `format:check` が追加され、ローカル品質チェックの幅が広がった。
- 継続課題:
  - 募集メンション分割未対応、同時更新競合、DB例外誤判定、リマインダー失敗時削除、429対策不足。

## 擬似diff（任意）
- 1) 募集メンション分割送信（`bosyu` / `bpsr`）
```diff
-export function buildBosyuMentionMessage(members, customMessage?) { ...string... }
+export function buildBosyuMentionMessages(members, customMessage?) { ...string[]... }

-const mentionMessage = buildBosyuMentionMessage(...)
-await originalMessage.reply({ content: mentionMessage })
+for (const part of buildBosyuMentionMessages(...)) {
+  await originalMessage.reply({ content: part })
+}
```

- 2) DB重複例外の分類（`src/db.ts`）
```diff
-} catch {
-  return false
+} catch (error) {
+  if (isSqliteConstraint(error)) return false
+  throw error
 }
```

- 3) リマインダー失敗時の保持（`src/scheduler.ts`）
```diff
-} finally {
-  deleteReminder(reminder.id)
+  deleteReminder(reminder.id)
+} catch (error) {
+  rescheduleReminder(reminder.id, nextRetryAt)
+} finally {
   activeTimers.delete(reminder.id)
 }
```

## 参考（一次情報優先）
- Discord Interactions（未確認）: https://discord.com/developers/docs/interactions/receiving-and-responding
- Discord Rate Limits（未確認）: https://discord.com/developers/docs/topics/rate-limits
- discord.js docs（未確認）: https://discord.js.org/docs/packages/discord.js/main/general/welcome
- Sapphire docs（未確認）: https://www.sapphirejs.dev/docs/Guide/getting-started/
- SQLite docs（未確認）: https://www.sqlite.org/docs.html
