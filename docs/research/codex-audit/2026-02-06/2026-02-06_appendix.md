# 付録（2026-02-06）

## 重要な設計メモ（将来拡張のため）
- 権限レイヤ案:
  - `Precondition` は「実行可否の一次判定」に限定し、詳細監査（誰が何を拒否されたか）は共通ロガーへ集約する。
  - `restricted` の判定は `permission-utils.ts` に一本化し、コマンド/ボタン側で重複実装しない。
  - `verify` 編集/削除の判定関数は `VerifyButtonHandler` から `permission-utils.ts` へ移して再利用する。
- 共通ユーティリティ案:
  - メンション分割送信は `lib/message-chunk-utils.ts`（新規）へ共通化し、`bosyu`/`bpsr`/`mention-reactors` で使い回す。
  - 429再試行は `lib/discord-send-utils.ts`（新規）に `sendWithRetry` として集約する。
  - Interaction返信ヘルパー（`replyEphemeral` / `safeFollowUp`）を追加し、`ephemeral` 指定ゆれを防ぐ。
- エラー分類/ログ設計案:
  - レベルを `expected_denied` / `recoverable` / `fatal` の3段に分ける。
  - `expected_denied` はDM通知せず集計ログのみ、`recoverable` は閾値超過時のみ通知、`fatal` は即通知。
  - `errorCode` 命名規則を `DOMAIN_ACTION_KIND`（例: `DB_ALLOW_INSERT_FATAL`）で統一。
- 設定管理案:
  - `.env` 読み取り値を起動時にバリデートする（`OWNER_ID` 未設定時の挙動を明示）。
  - 通知抑制や再試行回数を環境変数化（例: `ERROR_NOTIFY_THROTTLE_SEC`, `MENTION_SEND_MAX_RETRY`）。
  - `config.ts` に「デフォルト値＋検証」関数を集約する。

## 擬似diff（任意）
- 1) DB重複判定の厳密化（`src/db.ts`）
```diff
 try {
   stmt.run(...)
   return true
-} catch {
-  return false
+} catch (error) {
+  if (isSqliteConstraint(error)) return false
+  throw error
 }
```

- 2) 募集メンションの分割送信（`src/lib/bosyu-utils.ts`, `src/interaction-handlers/BosyuMentionButtonHandler.ts`）
```diff
-export function buildBosyuMentionMessage(members, customMessage?) { ...string... }
+export function buildBosyuMentionMessages(members, customMessage?) { ...string[]... }

-await originalMessage.reply({ content: mentionMessage })
+for (const part of mentionMessages) {
+  await originalMessage.reply({ content: part })
+}
```

- 3) リマインダー失敗時の再試行化（`src/scheduler.ts`）
```diff
 try {
   await user.send(...)
-} finally {
-  deleteReminder(reminder.id)
+  deleteReminder(reminder.id)
+} catch (error) {
+  rescheduleReminder(reminder.id, nextRetryAt)
 }
```

## 参考（一次情報優先）
- Discord Interactions（未確認）: https://discord.com/developers/docs/interactions/receiving-and-responding
- Discord Rate Limits（未確認）: https://discord.com/developers/docs/topics/rate-limits
- discord.js docs（未確認）: https://discord.js.org/docs/packages/discord.js/main/general/welcome
- Sapphire docs（未確認）: https://www.sapphirejs.dev/docs/Guide/getting-started/
- SQLite docs（未確認）: https://www.sqlite.org/docs.html
