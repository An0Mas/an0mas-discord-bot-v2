# 改善計画（10件・優先順）（2026-02-06）

> 各項目は「小差分」を優先し、後方互換の案も併記すること。

## 1)
- タイトル: 権限設定INSERTの例外分類を導入する
- 目的: DB障害と重複登録を正しく区別し、誤案内を防ぐ。
- 根拠（該当箇所）: `src/db.ts:214-225`, `src/db.ts:247-258`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: `catch` で `SQLITE_CONSTRAINT_*` のみ `false` を返し、それ以外は再throwする。後方互換として戻り値仕様（重複時 `false`）は維持する。
- 実装手順（箇条書き）:
  - `addAllowedUser` / `addAllowedRole` の `catch` を `catch (error)` に変更。
  - エラーコード判定ヘルパーを `db.ts` 内に追加。
  - 非重複系エラーは throw して既存エラーリスナーへ伝播。
- テスト観点:
  - 手動: `/allow user add` を同一ユーザーで2回実行し、2回目が重複メッセージになること。
  - 手動: DBファイルロック時に「重複」ではなくエラーとして扱われること。
  - 自動: 一時DBで重複/非重複例外を分けて戻り値を検証。
- ロールバック案:
  - 判定ヘルパーを削除し、従来 `catch { return false; }` に戻す。
- 参考/未確認:
  - SQLite result codes（未確認）: https://www.sqlite.org/rescode.html

## 2)
- タイトル: 募集メンションを分割送信対応にする（bosyu/bpsr）
- 目的: 2000文字制限超過による送信失敗を防止する。
- 根拠（該当箇所）: `src/lib/bosyu-utils.ts:580`, `src/lib/bosyu-bpsr-utils.ts:687`, `src/interaction-handlers/BosyuMentionButtonHandler.ts:107`, `src/interaction-handlers/BosyuBpsrMentionButtonHandler.ts:109`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: 既存 `build*MentionMessage` を `build*MentionMessages`（配列返却）へ拡張し、ハンドラ側で順次送信する。後方互換として既存customId/操作フローは維持。
- 実装手順（箇条書き）:
  - `bosyu-utils.ts` と `bosyu-bpsr-utils.ts` に共通の分割ロジックを追加。
  - メンション送信ハンドラで配列を順次 `reply/send`。
  - 分割後も先頭文面（「募集主からのお知らせ」）は維持。
- テスト観点:
  - 手動: 参加者80人超を想定した文字列長で送信成功すること。
  - 手動: カスタムメッセージあり/なし両方で分割されること。
  - 自動: 1900文字境界のユニットテスト。
- ロールバック案:
  - 配列返却を単一文字列返却へ戻し、送信処理を1回に戻す。
- 参考/未確認:
  - Discord message limits（未確認）: https://discord.com/developers/docs/resources/channel#create-message

## 3)
- タイトル: `mention-reactors` の全件取得＋429再試行を実装する
- 目的: 大規模サーバーでもメンション漏れを防ぎ、送信成功率を上げる。
- 根拠（該当箇所）: `src/lib/mention-reactors-utils.ts:192-205`, `src/interaction-handlers/MentionReactorsButtonHandler.ts:117-120`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Med
- 変更方針（小差分）: 既存関数のインターフェースは維持しつつ、内部をページング化・送信を軽量リトライにする。後方互換としてコマンド仕様は変更しない。
- 実装手順（箇条書き）:
  - `fetchReactionUsers` / `fetchAllReactionUsers` を `after` ページング対応。
  - `sendWithRetry` ヘルパーを追加し、429時 `retry_after` で待機。
  - メッセージ分割送信ループで `sendWithRetry` を利用。
- テスト観点:
  - 手動: 100人超リアクションで全員取得できること。
  - 手動: 疑似429（短間隔連投）時に最終的に送信完了すること。
  - 自動: ページング関数のモックテスト。
- ロールバック案:
  - ページングを外し、旧 `limit: 100` 実装へ戻す。
- 参考/未確認:
  - Discord Rate Limits（未確認）: https://discord.com/developers/docs/topics/rate-limits

## 4)
- タイトル: 募集ボタン更新に競合対策（再取得再計算）を入れる
- 目的: 同時クリック時のロストアップデートを減らす。
- 根拠（該当箇所）: `src/interaction-handlers/BosyuButtonHandler.ts:45-105`, `src/interaction-handlers/BosyuBpsrButtonHandler.ts:46-107`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Med
- 変更方針（小差分）: `interaction.message` の埋め込みではなく、更新直前に `message.fetch()` した最新状態で `apply*Action` する。後方互換としてEmbed構造は維持。
- 実装手順（箇条書き）:
  - ボタンハンドラ内で最新メッセージ再取得関数を追加。
  - 最新状態に対してアクション適用→`interaction.update`。
  - 更新競合時は1回だけ再試行（失敗時はno-op通知）。
- テスト観点:
  - 手動: 2ユーザー同時クリックで状態破綻しないこと。
  - 手動: 同一ユーザー連打時に二重参加しないこと。
  - 自動: `apply*Action` の再計算テスト。
- ロールバック案:
  - 再取得処理を削除し、従来ローカル状態更新へ戻す。
- 参考/未確認:
  - Discord interactions update semantics（未確認）: https://discord.com/developers/docs/interactions/receiving-and-responding

## 5)
- タイトル: リマインダー送信失敗時の削除方針を見直す
- 目的: 一時障害で通知が消える問題をなくす。
- 根拠（該当箇所）: `src/scheduler.ts:15-26`
- 影響度（High/Med/Low）: High
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Med
- 変更方針（小差分）: 失敗時削除をやめ、再試行可能状態を残す。後方互換として既存テーブルは初回はカラム追加なしで運用し、必要時に拡張。
- 実装手順（箇条書き）:
  - `executeReminder` の `finally deleteReminder` を成功時のみへ変更。
  - 失敗時は `notify_at` を数分後へ更新する関数を `db.ts` に追加。
  - 再試行上限を定数で管理（超過時はオーナー通知）。
- テスト観点:
  - 手動: DM拒否ユーザーで失敗後にレコードが残ること。
  - 手動: 次回再試行時に再送されること。
  - 自動: 成功/失敗分岐のユニットテスト。
- ロールバック案:
  - 失敗時再スケジュール処理を削除し、従来の即削除へ戻す。
- 参考/未確認:
  - Discord DM failures（未確認）: https://discord.com/developers/docs/topics/opcodes-and-status-codes

## 6)
- タイトル: Precondition拒否通知をレベル分離し、オーナーDMを抑制する
- 目的: 監視ノイズを減らし、重大障害通知の視認性を上げる。
- 根拠（該当箇所）: `src/listeners/ChatInputCommandDenied.ts:23-29`, `src/lib/error-notify.ts:19-41`
- 影響度（High/Med/Low）: Med
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: Deniedイベントでは既知の権限拒否を通知対象外にし、未知エラーのみ通知。後方互換としてユーザーへのephemeral返信は維持。
- 実装手順（箇条書き）:
  - `error.identifier` を判定し、`GuildAllowed`/`RestrictedAllowed` は通知スキップ。
  - 必要なら5分窓の重複抑止Mapを `error-notify.ts` に追加。
  - 監査用にログは残す。
- テスト観点:
  - 手動: 権限なし実行でユーザー返信は出るがDM通知されないこと。
  - 手動: 未知例外ではDM通知されること。
  - 自動: フィルタ関数単体テスト。
- ロールバック案:
  - フィルタを削除し、全件通知へ戻す。
- 参考/未確認:
  - Sapphire Listeners（未確認）: https://www.sapphirejs.dev/docs/Guide/listeners

## 7)
- タイトル: `ephemeral: true` を `MessageFlags.Ephemeral` に統一する
- 目的: プロジェクト規約準拠と実装の一貫性確保。
- 根拠（該当箇所）: `src/interaction-handlers/BosyuButtonHandler.ts:72` ほか複数
- 影響度（High/Med/Low）: Med
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: 返信オプションを機械的に置換。後方互換として挙動（ephemeral応答）は維持。
- 実装手順（箇条書き）:
  - 該当ファイルに `MessageFlags` を追加import。
  - `ephemeral: true` を `flags: MessageFlags.Ephemeral` に置換。
  - `pnpm typecheck` で型確認。
- テスト観点:
  - 手動: 募集メンション確認・モーダルエラーがephemeral表示されること。
  - 自動: 置換漏れを `Select-String 'ephemeral:\\s*true'` で検出。
- ロールバック案:
  - 置換コミットを戻す。
- 参考/未確認:
  - discord.js MessageFlags（未確認）: https://discord.js.org/docs/packages/discord.js/main/MessageFlags:Enum

## 8)
- タイトル: catchで握る箇所に `notifyErrorToOwner` を明示追加する
- 目的: 障害観測性を上げ、再現調査コストを下げる。
- 根拠（該当箇所）: `src/interaction-handlers/BpsrRoleButtonHandler.ts:113-125`, `src/interaction-handlers/VerifyModalHandler.ts:115-170`, `src/interaction-handlers/VerifyButtonHandler.ts:94-98`
- 影響度（High/Med/Low）: Med
- 工数（S/M/L）: S
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: ユーザー向け返信は維持しつつ、catch内で `notifyErrorToOwner` を呼ぶ。後方互換としてUI文面は変えない。
- 実装手順（箇条書き）:
  - 各catchに `notifyErrorToOwner` 呼び出しを追加。
  - source/errorCode を簡易規約化（`IH_xxx_WARN`）。
  - 二重返信を避ける既存分岐はそのまま維持。
- テスト観点:
  - 手動: 権限エラーを意図的に起こし、ユーザー返信とオーナー通知の両方を確認。
  - 自動: ヘルパー呼び出しのユニットテスト（モック）。
- ロールバック案:
  - catch内の通知呼び出しを削除。
- 参考/未確認:
  - プロジェクト方針（AGENTS.md）準拠

## 9)
- タイトル: DBスキーマバージョン管理（最小マイグレーション）を導入する
- 目的: 将来のテーブル変更を安全に段階適用する。
- 根拠（該当箇所）: `src/db.ts:23-92`（`meta` はあるがバージョン未使用）
- 影響度（High/Med/Low）: Med
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Med
- 変更方針（小差分）: `schema_version` を `meta` に保存し、`initDatabase` で順次 migration 実行。後方互換として現行スキーマを v1 と定義。
- 実装手順（箇条書き）:
  - `getSchemaVersion` / `setSchemaVersion` を追加。
  - `migrations` 配列を作成し、未適用分のみ実行。
  - `docs/DB-SCHEMA.md` にバージョン欄を追記。
- テスト観点:
  - 手動: 空DB初期化と既存DB再起動の両方で失敗しないこと。
  - 自動: migration関数の冪等性テスト。
- ロールバック案:
  - migration呼び出しを無効化し、従来の `CREATE TABLE IF NOT EXISTS` のみに戻す。
- 参考/未確認:
  - SQLite migration patterns（未確認）: https://www.sqlite.org/lang_altertable.html

## 10)
- タイトル: DX最小基盤（lint/test/build/CI雛形）を整備する
- 目的: 回帰検知を手動依存から脱却する。
- 根拠（該当箇所）: `package.json` scripts（`dev/typecheck/verify`のみ）、`.github/workflows` 未確認
- 影響度（High/Med/Low）: Med
- 工数（S/M/L）: M
- リスク（Low/Med/High）: Low
- 変更方針（小差分）: まずは `typecheck` をCI化し、lint/testは段階導入。後方互換として既存コマンドは残す。
- 実装手順（箇条書き）:
  - `package.json` に `build`（`tsc`）を追加。
  - `eslint` を最小設定で導入し `lint` スクリプト追加。
  - `.github/workflows/ci.yml` で `pnpm install` + `pnpm typecheck` + `pnpm lint` を実行。
- テスト観点:
  - 手動: ローカルで `pnpm lint` / `pnpm build` が通ること。
  - 自動: PR作成時にCIが走り、失敗時にブロックされること。
- ロールバック案:
  - CIワークフローを無効化し、スクリプトを削除。
- 参考/未確認:
  - GitHub Actions Node.js guide（未確認）: https://docs.github.com/actions/guides/building-and-testing-nodejs
