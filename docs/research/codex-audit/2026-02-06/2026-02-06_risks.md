# リスク一覧（2026-02-06）

## High
- タイトル: 募集メンションが2000文字制限を超えると送信失敗する
  - 現象: 参加者が多い募集で `<@id>` を1メッセージ連結して送るため、API制限超過で失敗する。
  - 根拠（該当ファイル/関数/行の目安）: `src/lib/bosyu-utils.ts:580` / `src/lib/bosyu-bpsr-utils.ts:687` の TODO、`src/interaction-handlers/BosyuMentionButtonHandler.ts:107`、`src/interaction-handlers/BosyuBpsrMentionButtonHandler.ts:109`
  - 影響: 通知不能、操作失敗、ユーザー体験悪化。大量利用時に発生確率が高い。
  - 推奨対応: 分割送信関数を共通化し、チャンク送信＋間引き（軽量キュー）を導入する。

- タイトル: 募集ボタンの同時操作でロストアップデートが発生しうる
  - 現象: 同一メッセージを各ハンドラがローカル計算して `interaction.update` しており、同時クリックで後勝ち上書きになる。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/BosyuButtonHandler.ts:45-105`、`src/interaction-handlers/BosyuBpsrButtonHandler.ts:46-107`
  - 影響: 参加者一覧・残枠の不整合、二重参加/取り消し漏れ、信頼性低下。
  - 推奨対応: 更新前に最新メッセージ再取得＋再計算、またはリビジョン埋め込みによる楽観ロックを導入する。

- タイトル: 権限設定追加処理が例外を握りつぶし、障害を重複扱いする
  - 現象: `addAllowedUser`/`addAllowedRole` が例外種別を見ず `false` を返す。
  - 根拠（該当ファイル/関数/行の目安）: `src/db.ts:214-225`、`src/db.ts:247-258`
  - 影響: DBロックやI/O障害時に「既に登録済み」と誤表示され、障害検知が遅れる。
  - 推奨対応: `SQLITE_CONSTRAINT` のみ重複扱い、その他は再throwしてグローバル通知へ流す。

- タイトル: リマインダー送信失敗時にデータが消失する
  - 現象: DM送信失敗しても `finally` で必ず `deleteReminder` している。
  - 根拠（該当ファイル/関数/行の目安）: `src/scheduler.ts:15-26`
  - 影響: 一時的なAPI障害・ネットワーク障害でも通知が永続的に失われる。
  - 推奨対応: 失敗時は再試行可能状態に残す（`retry_count`/`next_retry_at` 追加か、削除しない方針に変更）。

- タイトル: Precondition拒否を毎回オーナーDM通知しており、監視ノイズが高い
  - 現象: 予期された権限拒否まで全件 `notifyErrorToOwner` される。
  - 根拠（該当ファイル/関数/行の目安）: `src/listeners/ChatInputCommandDenied.ts:23-29`
  - 影響: 通知洪水で本当に重要な障害が埋もれる。運用監視が機能不全になりやすい。
  - 推奨対応: 通知レベルを分離（拒否系は集計ログのみ/閾値超過時のみ通知）し、短時間重複を抑制する。

## Med
- タイトル: `mention-reactors` はリアクションユーザー取得が最大100件で打ち切られる
  - 現象: `reaction.users.fetch({ limit: 100 })` を1回のみ実行している。
  - 根拠（該当ファイル/関数/行の目安）: `src/lib/mention-reactors-utils.ts:192-205`
  - 影響: 大規模サーバーでメンション漏れが発生し、機能要件を満たせない。
  - 推奨対応: `after` を使ったページングで全件取得する。

- タイトル: メンション送信時の429対策がない
  - 現象: 連続 `send` で再試行・待機制御がない。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/MentionReactorsButtonHandler.ts:117-120`、`src/lib/error-notify.ts:30-37`
  - 影響: バースト時に送信失敗し、通知欠落や再実行の手間が増える。
  - 推奨対応: 軽量キュー＋指数バックオフ（`retry_after` 優先）を入れる。

- タイトル: `ephemeral: true` が残存し、プロジェクト規約と不整合
  - 現象: 一部ハンドラで非推奨指定を継続使用。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/BosyuButtonHandler.ts:72` ほか（複数）
  - 影響: 実装規約から逸脱し、将来の保守時に混乱・修正漏れが発生しやすい。
  - 推奨対応: `flags: MessageFlags.Ephemeral` へ統一置換。

- タイトル: 例外をcatchして握る箇所があり、障害がグローバル監視に載らない
  - 現象: 返信だけして `throw` しない/`notifyErrorToOwner` しない箇所がある。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/BpsrRoleButtonHandler.ts:113-125`、`src/interaction-handlers/VerifyModalHandler.ts:115-170`
  - 影響: 本番障害の再現性と検知性が低下する。
  - 推奨対応: catch時は `notifyErrorToOwner` を明示呼び出し、重要例外は再throwする。

- タイトル: DBマイグレーション版管理が未実装
  - 現象: `meta` テーブルはあるが `schema_version` 管理がない。
  - 根拠（該当ファイル/関数/行の目安）: `src/db.ts:26-28`
  - 影響: 将来のスキーマ変更時に手作業差分が増え、起動時失敗リスクが高まる。
  - 推奨対応: 起動時マイグレーション関数を導入し、段階適用する。

- タイトル: `mention-reactors` の最初の応答公開範囲がコード上で明示されていない
  - 現象: `deferReply()` のオプション未指定で可視範囲の意図が読み取りにくい。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/MentionReactorsButtonHandler.ts:90`
  - 影響: 仕様変更時に誤って公開範囲を変えるリスク。
  - 推奨対応: 設計意図をコメント化し、必要なら `deferReply({ flags: ... })` に明示する。

## Low
- タイトル: `/help` のキャッシュ実装が分散し、更新時の整合が取りづらい
  - 現象: `HelpCommand` と `HelpButtonHandler` で別キャッシュ変数を保持。
  - 根拠（該当ファイル/関数/行の目安）: `src/commands/HelpCommand.ts:17-24`、`src/interaction-handlers/HelpButtonHandler.ts:20-27`
  - 影響: 将来ホットリロードや再読込機能を入れる際に二重修正が必要。
  - 推奨対応: ヘルプキャッシュを `help-utils.ts` に一本化する。

- タイトル: Thread未対応の型アサーションが残っている
  - 現象: `TextChannel` へ固定キャストし、スレッドを扱えない。
  - 根拠（該当ファイル/関数/行の目安）: `src/interaction-handlers/BosyuMentionButtonHandler.ts:48-50`、`src/interaction-handlers/BosyuBpsrMentionButtonHandler.ts:49-51`
  - 影響: スレッド運用時に機能制限や意図しない失敗が起きる。
  - 推奨対応: `TextBasedChannel` ベースへ置き換える。

- タイトル: DX基盤（lint/test/build/CI）が不足
  - 現象: `package.json` に `lint`/`test`/`build` がない。CI設定ファイルも未確認。
  - 根拠（該当ファイル/関数/行の目安）: `package.json` scripts、`.github/workflows` 未確認
  - 影響: 回帰混入の検知が手動依存になる。
  - 推奨対応: 最小の品質ゲート（typecheck + lint）をCI化する。

## 参考
- Discord Interactions: https://discord.com/developers/docs/interactions/receiving-and-responding （未確認）
- Discord Rate Limits: https://discord.com/developers/docs/topics/rate-limits （未確認）
- discord.js MessageFlags: https://discord.js.org/docs/packages/discord.js/main/MessageFlags:Enum （未確認）
- SQLite result codes: https://www.sqlite.org/rescode.html （未確認）
- SQLite ON CONFLICT: https://www.sqlite.org/lang_conflict.html （未確認）
