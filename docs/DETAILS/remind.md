# DETAILS — /remind（リマインダー）

## 概要
指定時刻にDMで通知を送るリマインダー機能。

## コマンド

### /remind
リマインダーを登録する。引数なしでモーダルを表示。

### /remind-list
自分のリマインダー一覧を表示し、削除できる。

---

## /remind 仕様

### 入力（モーダル）

| 項目 | フィールド名 | 必須 | 形式 | 備考 |
|------|-------------|------|------|------|
| 通知時間 | `time` | ✅ | `HH:MM` | 全角数字・コロン許可（例: `14:00`, `１４：００`） |
| 何分前 | `minutes_before` | ❌ | 数値 | 未入力で0（指定時間ちょうどに通知） |
| 通知内容 | `content` | ✅ | テキスト | 通知時に表示するメッセージ |

### モーダルラベル（推奨）
- time: `通知時間（例: 14:00）`
- minutes_before: `何分前に通知（未入力で0）`
- content: `通知内容`

### 入力検証
- `time`: 
  - 全角を半角に変換後、`HH:MM` 形式として解釈
  - 0-23時、0-59分の範囲内であること
  - 不正な形式はエラー
- `minutes_before`:
  - 全角を半角に変換
  - 数値として解釈できること（空欄は0扱い）
  - 0以上であること
- `content`:
  - 空欄不可

### 動作
1. モーダル送信後、リマインダーをDBに保存
2. 通知時刻を計算（今日の `time` - `minutes_before` 分）
3. 通知時刻が過去の場合はエラー
4. 登録完了メッセージをephemeralで返す

### 通知
- 指定時刻にユーザーへDMを送信
- DMには登録した `content` を表示
- 通知後、DBからリマインダーを削除

---

## /remind-list 仕様

### 表示
- ユーザー自身のリマインダーをナンバリング表示
- 各行: `1. 14:00 - 会議開始`（通知時刻と内容の要約）
- ephemeral（本人のみ表示）

### 削除機能
- 番号ボタン（1, 2, 3...）を表示
- ボタン押下で該当リマインダーを削除
- 削除後、一覧を更新

### 空の場合
- 「リマインダーはありません」と表示

---

## データベース

### テーブル定義
```sql
CREATE TABLE IF NOT EXISTS reminders (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id TEXT NOT NULL,
  notify_at INTEGER NOT NULL,  -- Unix timestamp（通知時刻）
  content TEXT NOT NULL,
  created_at INTEGER NOT NULL  -- Unix timestamp（登録時刻）
);
```

### インデックス（推奨）
```sql
CREATE INDEX idx_reminders_user_id ON reminders(user_id);
CREATE INDEX idx_reminders_notify_at ON reminders(notify_at);
```

---

## 通知スケジューラ

### 起動時
1. DBから未通知のリマインダーを全件取得
2. 各リマインダーに対してタイマーを設定
3. 通知時刻が過去のものは即座に通知

### 新規登録時
- 該当リマインダーのタイマーを設定

### 通知実行時
1. ユーザーにDMを送信
2. DBからリマインダーを削除
3. 送信失敗時（DMブロック等）はログ出力のみ、DBからは削除

---

## エラーメッセージ

| ケース | メッセージ |
|--------|-----------|
| 時刻形式不正 | `時刻は HH:MM 形式で入力してください（例: 14:00）` |
| 時刻が過去 | `通知時刻が過去です。未来の時刻を指定してください。` |
| 分が数値でない | `「何分前」は数値で入力してください。` |
| 内容が空 | `通知内容を入力してください。` |

---

## 将来拡張（v2以降）

| 機能 | 説明 |
|------|------|
| 日付指定 | `MM/DD` 形式で翌日以降も指定可能 |
| 繰り返し | 毎日、曜日指定などの繰り返し通知 |
