# DETAILS — bosyu（募集） v0.1

## 0. 目的
- 参加者募集メッセージ（Embed）を投稿し、ボタン操作で
  - 参加者リスト
  - 残り募集人数
  - 募集の締切（OPEN/CLOSED）
  を管理する。

## 1. 状態モデル
### 1.1 状態
- OPEN：募集中
- CLOSED：募集停止

### 1.2 状態遷移
- `close`（締切/再開：ownerのみ）
  - OPEN → CLOSED
  - CLOSED → OPEN

## 2. コマンドI/F（Slash）
- `/bosyu`
  - `slots`: number
    - 意味：作成者“以外”に「あと何名参加できるか」
  - `title`: string
  - `body`: string（改行可）

## 3. 出力（Embed）仕様
> スクショ準拠。厳密なUI再現は不要だが、情報構造は一致させる。

### 3.1 Embed表示（要点）
- Embedの上部に `title` を表示（author欄、またはそれに相当する目立つ位置）
- Embed本文（説明）は以下の構造を推奨：
  - 1行目：状態表示
    - OPEN：`【募集中】`
    - CLOSED：`【募集停止】`
  - 2行目以降：`body`

※ “どの欄に出すか（title/description/author等）” は実装都合で調整可。
※ ただし「状態表示文字列」は固定（パース/復元の基準になるため）。

### 3.2 フィールド（inline=true）
#### 参加メンバーリスト
- フィールド名：`参加メンバーリスト`
- 初期値：作成者のメンション（例：`<@123...>`）
- 表示形式：メンションを改行区切りで列挙
- 参加者が0人になった場合：`` `参加者無し` ``

#### 募集人数
- フィールド名：`募集人数`
- 表示形式：`あと{remaining}名`
- 初期値：`remaining = slots`

### 3.3 画像
- OPEN：
  - `https://1.bp.blogspot.com/-0LJSR56tXL8/VVGVS2PQRsI/AAAAAAAAtkA/9EI2ZHrT5w8/s800/text_sankasya_bosyu.png`
- CLOSED：
  - `https://1.bp.blogspot.com/-fDI1k-dkGO8/X5OcjEhqRUI/AAAAAAABcAc/DSrwuOQW6xMPgE1XZ8zvqhV0akkIctmTgCNcBGAsYHQ/s819/text_oshirase_eigyousyuuryou.png`

## 4. コンポーネント（ボタン）仕様
### 4.1 ボタン配置
```
行1: [参加] [参加取消]
行2: [締切/再開] [＋] [－] [編集] [📢メンション]
```

### 4.2 ボタン一覧
- `join`（Primary）：`参加`
- `cancel`（Danger）：`参加取消`
- `close`（Success）：状態に応じて `締切` / `再開`
- `plus`（Secondary）：`＋`（絵文字/ラベルどちらでも可）
- `minus`（Secondary）：`－`
- `edit`（Secondary）：`編集`（v0.1.2）
- `mention`（Secondary）：`📢メンション`（v0.1.3）

### 4.3 ボタンの有効/無効
- OPEN：
  - `join` / `cancel` / `plus` / `minus`：enabled
  - `close`：enabled（ラベル `締切`）
  - `edit` / `mention`：enabled
- CLOSED：
  - `join` / `cancel` / `plus` / `minus`：disabled
  - `close`：enabled（ラベル `再開`）
  - `edit` / `mention`：enabled（締切中でも操作可能）

## 5. 権限（owner判定）
- `close` / `plus` / `minus` / `edit` / `mention` は **募集作成者（owner）のみ**実行可能。
- `join` / `cancel` は **誰でも**実行可能。

### 5.1 owner_id の保持（必須）
- Embedの見た目（author icon等）では判定しない。
- 以下のいずれかで **owner_id を必ず保持**する：
  - ボタン `custom_id` に owner_id を含める（推奨）
  - Embed footer に `owner_id=<user_id>` を埋める

## 6. 操作ロジック（状態更新）
### 6.1 join（誰でも）
- 前提：状態がOPEN
- 条件：
  - 参加者リストに自分が未登録
  - `remaining > 0`
- 成功時：
  - 自分のメンションを参加者リスト末尾に追加
  - `remaining -= 1`
- 失敗時：
  - no-op（状態変更なし）
  - 失敗理由通知は任意（v0.1は旧挙動踏襲なら無言でOK）

### 6.2 cancel（誰でも）
- 前提：状態がOPEN
- 条件：参加者リストに自分が登録済み
- 成功時：
  - 自分のメンションを参加者リストから削除
  - 参加者が0人なら `` `参加者無し` ``
  - `remaining += 1`
- 失敗時：
  - no-op（状態変更なし）

### 6.3 plus/minus（ownerのみ）
- 前提：状態がOPEN
- plus：
  - `remaining += 1`
- minus：
  - `remaining > 0` のとき `remaining -= 1`
  - 0未満にしない

### 6.4 close（ownerのみ）
- OPEN → CLOSED：
  - 状態表示を `【募集停止】` に変更
  - 画像を CLOSED 用に変更
  - `join/cancel/plus/minus` を disabled
  - `close` は enabled のまま、ラベルを `再開` に変更
- CLOSED → OPEN：
  - 状態表示を `【募集中】` に変更
  - 画像を OPEN 用に変更
  - `join/cancel/plus/minus` を enabled
  - `close` は enabled のまま、ラベルを `締切` に変更

## 7. パース/復元規約（Embedから状態復元）
> DBなしで動かす前提のため、表示文字列を固定する。

- 状態判定：
  - 状態表示の文字列で判定（`【募集中】` / `【募集停止】`）
- 参加者取得：
  - `参加メンバーリスト` フィールドから改行区切りメンションを取得
  - `` `参加者無し` `` の場合は空リスト扱い
- remaining取得：
  - `募集人数` フィールド文字列 `あと{N}名` から数値Nを抽出

## 8. 入力制限・バリデーション（v0.1確定）
### 8.1 パラメータ制限
- `slots`：
  - 最小値：`1`（0以下は不可）
  - 最大値：`100`（実用的な上限）
  - 型：整数（number）
- `title`：
  - 最小長：`1`文字（空文字不可）
  - 最大長：`256`文字（Discord Embed titleの制限）
- `body`：
  - 最小長：`1`文字（空文字不可）
  - 最大長：`2000`文字（実用的な上限、Embed descriptionの4096文字制限より緩めに設定）

### 8.2 バリデーションエラー時の挙動
- コマンド実行時（`/bosyu`）に制限違反がある場合：
  - Discordのスラッシュコマンドのバリデーションエラーとして表示される（実装側で明示的にエラーメッセージを返す必要はない）
  - ただし、実装側で追加チェックを行う場合は、ユーザー向けに分かりやすいエラーメッセージを返す

### 8.3 ボタン操作の失敗時の挙動
- `join` 失敗時（参加済み・満員・CLOSED状態）：
  - **無言で no-op**（状態変更なし、エラーメッセージも表示しない）
- `cancel` 失敗時（未参加・CLOSED状態）：
  - **無言で no-op**（状態変更なし、エラーメッセージも表示しない）
- `plus` / `minus` / `close` 失敗時（owner権限なし・CLOSED状態でplus/minus）：
  - **無言で no-op**（状態変更なし、エラーメッセージも表示しない）

※ v0.1では「静かに失敗する」方針を採用。将来的にエラーメッセージを追加する場合は、`PLANS.md` に記載する。

## 9. 編集機能（v0.1.2）
### 9.1 目的
- 募集作成後に、タイトル/本文/人数を修正できるようにする。

### 9.2 編集モーダル
- `edit` ボタン押下で編集モーダルを表示する。
- 入力項目は作成時と同じ3項目（slots/title/body）。
- **プリフィル**：現在のEmbedから取得した値をデフォルト値として設定する。
  - slots：`募集人数` フィールドから数値を取得
  - title：Embedのタイトルから取得
  - body：Embed説明から状態表示行を除いた部分を取得

### 9.3 送信後の挙動
- Embedを更新する。
  - `title` / `body` / `remaining` を新しい値で上書き
  - `参加メンバーリスト` は**維持**（変更しない）
  - `status`（OPEN/CLOSED）は**維持**（変更しない）
- 人数変更で超過（メンバー数 > 残り人数）が発生しても許可する。
  - 例：メンバー5人、remaining=3 → 表示は `あと3名`（マイナス表示OK）

### 9.4 入力検証
- 作成時と同じバリデーションを適用する（8.1参照）。
- `slots`（募集人数）に全角数字が入力された場合は**半角に自動変換**する（例：`５` → `5`）。
- エラー時は ephemeral でエラーを返し、no-op（Embedは更新しない）。

### 9.5 権限
- `edit` ボタンは **募集作成者（owner）のみ**実行可能。
- 他ユーザーが押した場合は **無言で no-op**。

## 10. メンション機能（v0.1.3）
### 10.1 目的
- 募集参加者全員にメンションを送信し、開始通知や連絡事項を伝える。

### 10.2 フロー
1. `📢メンション` ボタン押下（ownerのみ）
2. エフェメラルで確認メッセージを表示
   - 「📢 参加者 {N}人 にメンションを送信します」
   - ボタン：`[✅ 送信]` `[📝 メッセージ付き]` `[❌ キャンセル]`
3. 操作に応じて処理
   - `✅ 送信`：定型文でメンション送信
   - `📝 メッセージ付き`：モーダルを表示し、カスタムメッセージを入力後に送信
   - `❌ キャンセル`：何もしない（エフェメラルを削除/更新）

### 10.3 送信メッセージ
- 募集メッセージへの返信（reply）として送信
- 形式：`{参加者メンション} {メッセージ}`
  - 定型文の場合：「@参加者1 @参加者2 募集主からのお知らせです」など
  - カスタムの場合：ユーザー入力メッセージ

### 10.4 メッセージ付きモーダル
- 入力項目：
  - メッセージ（1〜500文字）
- 送信後：入力されたメッセージと共にメンション送信

### 10.5 権限
- `mention` ボタンは **募集作成者（owner）のみ**実行可能。
- 他ユーザーが押した場合は **無言で no-op**。
