# DETAILS — bosyu-bpsr（BPSR募集） v0.3

> `/bosyu` のBPSR特化版。ロール（タンク/アタッカー/ヒーラー）別の人数制限付き参加管理を行う。
> 基本仕様は `/bosyu` を継承し、差分のみ本ファイルに記載する。

---

## 0. 目的
- BPSRのロール構成（タンク/アタッカー/ヒーラー）に対応した募集を作成する
- 参加者がどのロールで参加するかを明示的に選択できるようにする
- **ロール毎に人数制限を設ける**（v0.3で追加）

---

## 1. `/bosyu` との差分

### 1.1 参加ボタン
| 項目 | `/bosyu` | `/bosyu-bpsr` |
|------|----------|---------------|
| 参加ボタン | `参加`（1種類） | `🛡️タンク` `⚔️アタッカー` `💚ヒーラー`（3種類） |
| 参加時の動作 | リストに追加 | ロール別リストに追加 |

### 1.2 投稿者の自動参加
| 項目 | `/bosyu` | `/bosyu-bpsr` |
|------|----------|---------------|
| 初期参加者 | 作成者が自動参加 | **参加者なし**（作成者もボタンで参加） |

### 1.3 ロール変更
- 既に別ロールで参加済みの場合、新しいロールのボタンを押すと**自動でロール変更**
  - 例：タンクで参加中 → アタッカーボタン押下 → タンクから削除、アタッカーに追加
  - ターゲットロールに空きがある場合のみ変更可能

### 1.4 募集人数（v0.3で変更）
- **ロール毎に人数制限**を設定
  - 🛡️タンク：○名
  - ⚔️アタッカー：○名
  - 💚ヒーラー：○名
- 各ロールで定員に達すると、そのロールのボタンは実質無効（押しても参加不可）

---

## 2. コマンドI/F（Slash）
- `/bosyu-bpsr`（引数なし）
  - 常にモーダルで入力

---

## 3. モーダル入力（v0.3で変更）
5項目のモーダルで入力：

| # | 項目 | 説明 |
|---|------|------|
| 1 | タイトル | 募集タイトル（1〜100文字） |
| 2 | 内容 | 募集内容・備考（1〜1000文字） |
| 3 | 🛡️タンク人数 | タンク枠数（0以上） |
| 4 | ⚔️アタッカー人数 | アタッカー枠数（0以上） |
| 5 | 💚ヒーラー人数 | ヒーラー枠数（0以上） |

> 合計人数は1名以上必須

---

## 4. 出力（Embed）仕様

### 4.1 Embed表示
- `/bosyu` と同一構造
  - 1行目：状態表示（`【募集中】` / `【募集停止】`）
  - 2行目以降：`body`

### 4.2 フィールド（inline=true）

#### 🛡️タンク（参加者数/枠数）
- フィールド名：`🛡️タンク（{参加者数}/{枠数}）`
- 初期値：`` `参加者無し` ``
- 表示形式：メンションを改行区切りで列挙

#### ⚔️アタッカー（参加者数/枠数）
- フィールド名：`⚔️アタッカー（{参加者数}/{枠数}）`
- 初期値：`` `参加者無し` ``
- 表示形式：メンションを改行区切りで列挙

#### 💚ヒーラー（参加者数/枠数）
- フィールド名：`💚ヒーラー（{参加者数}/{枠数}）`
- 初期値：`` `参加者無し` ``
- 表示形式：メンションを改行区切りで列挙

### 4.3 画像
- `/bosyu` と同一（OPEN/CLOSED用の画像）

---

## 5. コンポーネント（ボタン）仕様

### 5.1 ボタン配置（v0.3で変更）
```
行1: [🛡️タンク] [⚔️アタッカー] [💚ヒーラー]
行2: [参加取消] [締切/再開] [編集] [📢メンション]
```

> ＋/－ボタンは削除（編集モーダルでロール別枠数を変更可能）

### 5.2 ボタン一覧
| customId | ラベル | スタイル | 説明 |
|----------|--------|----------|------|
| `join-tank` | 🛡️タンク | Primary | タンクとして参加 |
| `join-attacker` | ⚔️アタッカー | Primary | アタッカーとして参加 |
| `join-healer` | 💚ヒーラー | Primary | ヒーラーとして参加 |
| `cancel` | 参加取消 | Danger | 参加取消（全ロール共通） |
| `close` | 締切/再開 | Success | 募集の開閉 |
| `edit` | 編集 | Secondary | タイトル/内容/枠数を編集 |
| `mention` | 📢メンション | Secondary | 参加者全員にメンション送信 |

### 5.3 ボタンの有効/無効
- OPEN：
  - `join-*` / `cancel`：enabled
  - `close`：enabled（ラベル `締切`）
  - `edit` / `mention`：enabled
- CLOSED：
  - `join-*` / `cancel`：disabled
  - `close`：enabled（ラベル `再開`）
  - `edit` / `mention`：enabled（締切中でも操作可能）

---

## 6. 権限（owner判定）
- `close` / `edit` / `mention` は **募集作成者（owner）のみ**実行可能
- `join-*` / `cancel` は **誰でも**実行可能

---

## 7. 操作ロジック（状態更新）

### 7.1 join-tank / join-attacker / join-healer（誰でも）
- 前提：状態がOPEN
- 条件分岐：
  - **未参加の場合**：
    - 該当ロールに空き枠があれば追加
    - 空きがなければ no-op
  - **別ロールで参加済みの場合**：
    - ターゲットロールに空き枠があれば、元のロールから削除して新しいロールに追加
    - 空きがなければ no-op
  - **同じロールで参加済みの場合**：
    - no-op
- 失敗時：無言で no-op

### 7.2 cancel（誰でも）
- 前提：状態がOPEN
- 条件：いずれかのロールに参加済み
- 成功時：参加中のロールから削除
- 失敗時：無言で no-op

### 7.3 close / edit
- ownerのみ実行可能
- editは5項目モーダルを表示し、参加者リストは維持

---

## 8. パース/復元規約（Embedから状態復元）

- 状態判定：description 1行目から `【募集中】` / `【募集停止】` を判定
- 参加者取得：
  - 各フィールドのvalueから取得
  - `` `参加者無し` `` の場合は空リスト扱い
- 枠数取得：フィールド名から `（{参加者数}/{枠数}）` をパース

---

## 9. 編集機能
- 5項目モーダルで編集
- 参加者リスト（全ロール）は維持

---

## 10. 入力制限・バリデーション
- タイトル：1〜100文字
- 内容：1〜1000文字
- 各ロール人数：0以上の整数
- 合計人数：1名以上

---

## 11. メンション機能
> `/bosyu` のメンション機能（セクション10）を継承。

- 対象：全ロールの参加者（タンク/アタッカー/ヒーラー全員）
- フロー・モーダル・権限は `/bosyu` と同一

