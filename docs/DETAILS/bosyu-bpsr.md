# DETAILS — bosyu-bpsr（BPSR募集） v0.2

> `/bosyu` のBPSR特化版。ロール（タンク/アタッカー/ヒーラー）別の参加管理を行う。
> 基本仕様は `/bosyu` v0.1.2 を継承し、差分のみ本ファイルに記載する。

---

## 0. 目的
- BPSRのロール構成（タンク/アタッカー/ヒーラー）に対応した募集を作成する
- 参加者がどのロールで参加するかを明示的に選択できるようにする

---

## 1. `/bosyu` との差分

### 1.1 参加ボタン
| 項目 | `/bosyu` | `/bosyu-bpsr` |
|------|----------|---------------|
| 参加ボタン | `参加`（1種類） | `🛡️タンク` `⚔️アタッカー` `💚ヒーラー`（3種類） |
| 参加時の動作 | リストに追加 | ロール別リストに追加 |

### 1.2 投稿者の自動参加
| 項目 | `/bosyu` | `/bosyu-bpsr` |
|------|----------|---------------|
| 初期参加者 | 作成者が自動参加 | **参加者なし**（作成者もボタンで参加） |

### 1.3 ロール変更
- 既に別ロールで参加済みの場合、新しいロールのボタンを押すと**自動でロール変更**
  - 例：タンクで参加中 → アタッカーボタン押下 → タンクから削除、アタッカーに追加
  - `remaining` は変化しない（メンバー総数は変わらないため）

### 1.4 募集人数
- `/bosyu` と同様、**全体で「あと○名」**を管理
- ロール別の人数制限は設けない

---

## 2. コマンドI/F（Slash）
- `/bosyu-bpsr`
  - `slots`: number（作成者以外にあと何名参加できるか）
  - `title`: string
  - `body`: string（改行可）

> 入力制限・バリデーションは `/bosyu` と同一（8.1参照）

---

## 3. 出力（Embed）仕様

### 3.1 Embed表示
- `/bosyu` と同一構造
  - 1行目：状態表示（`【募集中】` / `【募集停止】`）
  - 2行目以降：`body`

### 3.2 フィールド（inline=true）

#### 🛡️タンク
- フィールド名：`🛡️タンク`
- 初期値：`` `参加者無し` ``
- 表示形式：メンションを改行区切りで列挙

#### ⚔️アタッカー
- フィールド名：`⚔️アタッカー`
- 初期値：`` `参加者無し` ``
- 表示形式：メンションを改行区切りで列挙

#### 💚ヒーラー
- フィールド名：`💚ヒーラー`
- 初期値：`` `参加者無し` ``
- 表示形式：メンションを改行区切りで列挙

#### 募集人数
- フィールド名：`募集人数`
- 表示形式：`あと{remaining}名`
- 初期値：`remaining = slots`

### 3.3 画像
- `/bosyu` と同一（OPEN/CLOSED用の画像）

---

## 4. コンポーネント（ボタン）仕様

### 4.1 ボタン配置
```
行1: [🛡️タンク] [⚔️アタッカー] [💚ヒーラー]
行2: [取消] [締切/再開] [＋] [－]
行3: [編集]
```

### 4.2 ボタン一覧
| customId | ラベル | スタイル | 説明 |
|----------|--------|----------|------|
| `join-tank` | 🛡️タンク | Primary | タンクとして参加 |
| `join-attacker` | ⚔️アタッカー | Primary | アタッカーとして参加 |
| `join-healer` | 💚ヒーラー | Primary | ヒーラーとして参加 |
| `cancel` | 取消 | Danger | 参加取消（全ロール共通） |
| `close` | 締切/再開 | Success | `/bosyu` と同一 |
| `plus` | ＋ | Secondary | `/bosyu` と同一 |
| `minus` | － | Secondary | `/bosyu` と同一 |
| `edit` | 編集 | Secondary | `/bosyu` と同一 |

### 4.3 ボタンの有効/無効
- OPEN：
  - `join-*` / `cancel` / `plus` / `minus`：enabled
  - `close`：enabled（ラベル `締切`）
  - `edit`：enabled
- CLOSED：
  - `join-*` / `cancel` / `plus` / `minus`：disabled
  - `close`：enabled（ラベル `再開`）
  - `edit`：enabled

---

## 5. 権限（owner判定）
- `/bosyu` と同一
- `close` / `plus` / `minus` / `edit` は **募集作成者（owner）のみ**実行可能
- `join-*` / `cancel` は **誰でも**実行可能

---

## 6. 操作ロジック（状態更新）

### 6.1 join-tank / join-attacker / join-healer（誰でも）
- 前提：状態がOPEN
- 条件分岐：
  - **未参加の場合**：
    - `remaining > 0` であれば、該当ロールのリストに追加
    - `remaining -= 1`
  - **別ロールで参加済みの場合**：
    - 元のロールから削除、新しいロールに追加
    - `remaining` は変化しない
  - **同じロールで参加済みの場合**：
    - no-op
- 失敗時：無言で no-op

### 6.2 cancel（誰でも）
- 前提：状態がOPEN
- 条件：いずれかのロールに参加済み
- 成功時：
  - 参加中のロールから削除
  - `remaining += 1`
- 失敗時：無言で no-op

### 6.3 plus / minus / close / edit
- `/bosyu` と同一

---

## 7. パース/復元規約（Embedから状態復元）

- 状態判定：`/bosyu` と同一
- 参加者取得：
  - `🛡️タンク` / `⚔️アタッカー` / `💚ヒーラー` 各フィールドから取得
  - `` `参加者無し` `` の場合は空リスト扱い
- remaining取得：`/bosyu` と同一

---

## 8. 編集機能
- `/bosyu` v0.1.2 と同一
- 参加者リスト（全ロール）は維持

---

## 9. 入力制限・バリデーション
- `/bosyu` と同一（DETAILS/bosyu.md 8.1参照）
